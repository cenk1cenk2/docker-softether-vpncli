#!/bin/sh

# SOFTETHER START
echo
echo "Starting Softether Client..."
echo "--------------------------------------------------------------------------"
echo 
/s6-bin/softether-vpncli/vpnclient start
echo
echo "Creating new virtual ethernet adapter."
echo "--------------------------------------------------------------------------"
echo 
/s6-bin/softether-vpncli/vpncmd localhost /CLIENT /CMD nicdelete vpn 
/s6-bin/softether-vpncli/vpncmd localhost /CLIENT /CMD niccreate vpn
echo
echo "Importing defined ${CONNNAME} connection."
echo "--------------------------------------------------------------------------"
echo
/s6-bin/softether-vpncli/vpncmd localhost /CLIENT /CMD accountdisconnect ${CONNNAME}
/s6-bin/softether-vpncli/vpncmd localhost /CLIENT /CMD accountdelete ${CONNNAME}
# Writing this with expect here because command line interface does not allow / in start of filename
# Maybe there is another way of doing that.
/usr/bin/expect<<EOD
set timeout -1
spawn /s6-bin/softether-vpncli/vpncmd localhost /CLIENT /CMD
expect "VPN Client>"
send "accountimport\r"
expect "Import Source File Name: "
send "/s6-bin/softether-vpncli/${CONNNAME}.vpn\r"
expect "VPN Client>"
send "exit\r"
EOD
echo

if ! [[ -z ${MACADD} ]]; then
    echo
    echo "MAC Address variable defined in enviromental variables."
    echo "Setting MAC address of the interface to: ${MACADD}"
    echo "--------------------------------------------------------------------------"
    echo    
    /s6-bin/softether-vpncli/vpncmd localhost /CLIENT /CMD nicsetsetting vpn /MAC:${MACADD}
    /s6-bin/softether-vpncli/vpncmd localhost /CLIENT /CMD nicupgrade vpn
    echo
    echo "Restart VPN Client for MAC Address to be set."
    echo "--------------------------------------------------------------------------"
    echo 
    /s6-bin/softether-vpncli/vpnclient stop
    /s6-bin/softether-vpncli/vpnclient start
fi

echo
echo "Connecting to defined ${CONNNAME} connection."
echo "--------------------------------------------------------------------------"
echo
/s6-bin/softether-vpncli/vpncmd localhost /CLIENT /CMD accountconnect ${CONNNAME}

# This is only valid for internal connections.
if ! [[ -z ${INTCONN} ]]; then
    echo
    echo "Internal connection variable defined in enviromental variables."
    echo "Set adapter MTU to 1200."
    echo "--------------------------------------------------------------------------"
    echo
    ifconfig vpn_vpn mtu 1200
    sleep 1
    ifconfig vpn_vpn down && ifconfig vpn_vpn up
fi

echo
echo "Tailing log files..."
echo "--------------------------------------------------------------------------"
echo
tail -F /usr/local/libexec/softether/vpnclient/*_log/*.log &
echo
echo "Requesting IP Address from Server"
echo "--------------------------------------------------------------------------"
echo
dhclient vpn_vpn
IPADDRESS=$(ifconfig vpn_vpn | awk '/inet addr/{print substr($2,6)}')
if ! [[ -z "${IPADDRESS}" ]]; then
    echo
    echo "IP Address Obtained: ${IPADDRESS}"
    echo "--------------------------------------------------------------------------"
    echo
    NETWORKADDRESS=$(echo ${IPADDRESS} | sed -r -e 's/^([0-9]*\.[0-9]*\.[0-9]*\.).*$/\1/')
    while ping -c 1 -W 10 "${NETWORKADDRESS}1" >& /dev/null;:
    do
        echo "--------------------------------------------------------------------------"
        echo "IP Address: ${IPADDRESS}"
        echo "Connection to ${NETWORKADDRESS}1 can be established. User has valid IP configuration."
        echo "Sleeping 10 minutes."
        echo "--------------------------------------------------------------------------"
        sleep 600
    done
else
    echo "err: Can not obtain IP Address."
fi