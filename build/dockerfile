FROM alpine

RUN apk --no-cache --no-progress upgrade && \
    apk --no-cache --no-progress add bash shadow tini

# Install Softether
RUN set -xe && apk --no-cache add openssl readline ncurses curl busybox-extras && \
  apk --no-cache -t .build-deps add readline-dev openssl-dev ncurses-dev build-base cmake git && \
  git clone https://github.com/SoftEtherVPN/SoftEtherVPN.git /tmp/softether && \
  cd /tmp/softether && git submodule init && git submodule update && export USE_MUSL=YES && \
  ./configure && make -C tmp && make -C tmp install && cp /tmp/softether/build/libcedar.so /tmp/softether/build/libmayaqua.so /usr/lib && \
  rm -fr /tmp/softether && apk del --quiet --no-cache .build-deps && apk del --quiet --no-cache --purge && rm -rf /var/cache/apk/*

COPY entrypoint.sh /usr/bin/
RUN chmod +x /usr/bin/entrypoint.sh

# Cleanning
RUN apk del .build-deps ; \
    # Reintroduce necessary libraries
    apk add --no-cache --virtual .run-deps \
      libcap libcrypto1.0 libssl1.0 ncurses-libs readline su-exec dhclient ; \
    # Removing vpnbridge, vpncmd vpnserver and build files
    rm -rf /usr/local/bin/vpnbridge /usr/local/bin/vpnserver \
      /usr/local/libexec/softether/vpnbridge /usr/local/libexec/softether/vpnserver ;

RUN apk --no-cache add expect;
ENTRYPOINT ["/sbin/tini", "--", "/usr/bin/entrypoint.sh"]
